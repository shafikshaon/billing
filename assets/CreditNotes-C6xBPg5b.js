import{r as et,k as st,d as m,j as ot,l as nt,s as r,x as P,n as L,c as l,o as i,a as e,b as $,w as J,e as dt,h as p,v as U,m as x,F as I,g,t as d,u as h,f as a,q as A,p as lt}from"./index-Dk44aPgm.js";import{S as X}from"./SectionCard-CVQankNP.js";import{_ as it}from"./LineItemsEditor-CGHz0IW5.js";const at={class:"row g-3"},rt={class:"col-lg-6"},ut={class:"row g-3"},ct={class:"col-md-4"},mt={class:"d-flex gap-2"},pt={class:"col-md-4"},vt={class:"col-md-4"},ft={class:"col-md-12"},bt=["value"],xt={class:"col-md-6"},yt=["disabled"],It=["value"],gt={key:0,class:"row g-2 mt-1"},ht={class:"col-7"},_t=["value"],wt={class:"col-5"},Ct=["value"],Nt={class:"col-md-6"},kt=["disabled"],St=["value"],At={key:0,class:"row g-2 mt-1"},Tt={class:"col-7"},Vt=["value"],Dt={class:"col-5"},Ft=["value"],Pt={class:"col-md-12"},$t={class:"col-12"},Ut={class:"col-12"},Mt={class:"form-sticky-actions mt-3"},jt={class:"d-flex flex-wrap align-items-center justify-content-between gap-2 p-2"},qt={class:"d-flex align-items-center gap-2 flex-wrap"},Rt={class:"badge"},zt={class:"badge"},Ot={class:"badge"},Bt={class:"col-lg-6"},Et={class:"invoice-header d-flex justify-content-between align-items-start border-bottom pb-2 mb-3"},Lt={class:"invoice-brand"},Jt={key:0},Xt={key:1},Ht={key:2,class:"text-muted small"},Qt={key:3},Gt={key:4,class:"text-muted small"},Wt={key:0},Kt={key:1},Yt={class:"text-end"},Zt={key:0},te={class:"mb-2 info-block"},ee={class:"fw-semibold"},se={key:0},oe={key:1,class:"text-muted small"},ne={key:2,class:"text-muted small"},de={key:3,class:"text-muted small"},le={key:0},ie={key:1},ae={class:"table table-sm table-invoice align-middle mt-2"},re={class:"fw-medium"},ue={key:0,class:"text-muted small"},ce={class:"text-end"},me={class:"text-end"},pe={class:"text-end"},ve={key:0},fe={key:1},be={key:2},xe={class:"text-end"},ye={key:0},Ie={class:"mt-2 d-flex"},ge={class:"totals-card"},he={class:"line"},_e={class:"line"},we={class:"line grand"},Ce={key:0,class:"mt-2"},Ne={style:{"white-space":"pre-wrap"}},Ve={__name:"CreditNotes",setup(ke){const H=()=>new Date().toISOString().slice(0,10),k=ot(),Q=dt(),T=et(null),o=st({id:"",number:"",date:H(),merchantId:"",merchantAddressId:"",merchantContactId:"",customerId:"",customerAddressId:"",customerContactId:"",originalInvoiceId:"",reason:"",status:"draft",notes:"",currency:"BDT",items:[]}),G=m(()=>!!k.params.id);nt(()=>{if(k.params.id){const n=(r.creditNotes||[]).find(t=>t.id===k.params.id);n&&Object.assign(o,JSON.parse(JSON.stringify(n)))}else k.query.invoiceId&&(o.originalInvoiceId=String(k.query.invoiceId||""));o.originalInvoiceId&&(!o.merchantId||!o.customerId)&&B()});const v=m(()=>r.merchants.find(n=>n.id===o.merchantId)),M=m(()=>v.value?.addresses||[]),j=m(()=>v.value?.contacts||[]),V=m(()=>M.value.find(n=>n.id===o.merchantAddressId)),_=m(()=>j.value.find(n=>n.id===o.merchantContactId)),y=m(()=>r.customers.find(n=>n.id===o.customerId)),q=m(()=>y.value?.addresses||[]),R=m(()=>y.value?.contacts||[]),D=m(()=>q.value.find(n=>n.id===o.customerAddressId)),w=m(()=>R.value.find(n=>n.id===o.customerContactId)),W=m(()=>r.invoices.slice().sort((n,t)=>(n.number||"").localeCompare(t.number||""))),S=m(()=>r.invoices.find(n=>n.id===o.originalInvoiceId));function z(){const n=v.value;n&&(o.merchantAddressId=n.addresses?.find(t=>t.type==="primary")?.id||n.addresses?.[0]?.id||"",o.merchantContactId=n.contacts?.find(t=>t.type==="primary")?.id||n.contacts?.[0]?.id||"")}function O(){const n=y.value;n&&(o.customerAddressId=n.addresses?.find(t=>t.type==="primary")?.id||n.addresses?.[0]?.id||"",o.customerContactId=n.contacts?.find(t=>t.type==="primary")?.id||n.contacts?.[0]?.id||"")}P(()=>o.merchantId,()=>z()),P(()=>o.customerId,()=>O()),P(()=>o.originalInvoiceId,()=>B());function B(){const n=S.value;n&&(o.merchantId=n.merchantId||o.merchantId,o.customerId=n.customerId||o.customerId,o.merchantAddressId=n.merchantAddressId||o.merchantAddressId,o.merchantContactId=n.merchantContactId||o.merchantContactId,o.customerAddressId=n.customerAddressId||o.customerAddressId,o.customerContactId=n.customerContactId||o.customerContactId,(!o.merchantAddressId||!o.merchantContactId)&&z(),(!o.customerAddressId||!o.customerContactId)&&O(),o.items=(n.items||[]).map(t=>({id:L("cnli_"),productId:t.productId,description:t.description,qty:t.qty,unitPrice:Number(t.unitPrice||0),discountType:t.discountType||"none",discountValue:Number(t.discountValue||0),taxId:t.taxId||""})))}function F(n){const t=(Number(n.qty)||0)*(Number(n.unitPrice)||0),s=n.discountType||"none",c=Number(n.discountValue)||0,C=s==="percent"?t*c/100:s==="fixed"?(Number(n.qty)||0)*c:0;return Math.max(0,t-C)}const f=m(()=>{let n=0,t=0;for(const s of o.items||[]){const c=F(s);n+=c;const C=r.taxes.find(u=>u.id===s.taxId);C&&(t+=c*(Number(C.rate)||0)/100)}return{sub:n,tax:t,total:n+t}});function E(){const n=r.settings?.creditNote||{},t=Number(n.nextNumber||1),s=Math.max(0,Number(n.zeroPad||0)),c=n.prefix||"CN-";o.number=`${c}${String(t).padStart(s,"0")}`,n.nextNumber=t+1}function K(){return typeof window<"u"?window:null}function Y(){const n=K();if(!n||!T?.value)return;const t=T.value.outerHTML,s=n.open("","_blank","noopener,noreferrer");s&&(s.document.write(`
    <html>
      <head>
        <meta charset="utf-8"/>
        <title>${o.number||"Credit Note"}</title>
        <link rel="stylesheet" href="https://bootswatch.com/5/pulse/bootstrap.min.css"/>
        <style>
          @page { size: A4; margin: 10mm; }
          body { background:#fff; -webkit-print-color-adjust: exact; print-color-adjust: exact; margin: 0; }
          .print-area { width: 190mm; margin: 0 auto; padding: 10mm; border: none; }
          .print-area h4 { font-size: 20px; color: #4a148c; }
          .print-area table { font-size: 12px; }
        </style>
      </head>
      <body>
        ${t}
        <script>
          window.addEventListener('load', function(){
            setTimeout(function(){
              try { window.focus(); window.print(); } finally { window.close(); }
            }, 150);
          });
        <\/script>
      </body>
    </html>
  `),s.document.close())}async function Z(){if(!T?.value)return;async function n(){return window.pdfMake||(await new Promise((u,N)=>{const b=document.createElement("script");b.src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.10/build/pdfmake.min.js",b.onload=u,b.onerror=N,document.body.appendChild(b)}),await new Promise((u,N)=>{const b=document.createElement("script");b.src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.10/build/vfs_fonts.min.js",b.onload=u,b.onerror=N,document.body.appendChild(b)})),window.pdfMake}await n();const t=v.value,s=y.value,c=[[{text:"Product / Description",bold:!0},{text:"Qty",alignment:"right",bold:!0},{text:"Unit",alignment:"right",bold:!0},{text:"Discount",alignment:"right",bold:!0},{text:"Line",alignment:"right",bold:!0}],...(o.items||[]).map(u=>[r.products.find(N=>N.id===u.productId)?.name||u.description||"—",{text:String(u.qty||0),alignment:"right"},{text:Number(u.unitPrice||0).toFixed(2),alignment:"right"},{text:(u.discountType||"none")==="percent"?"-"+Number(u.discountValue||0).toFixed(0)+"%":(u.discountType||"none")==="fixed"?"- "+(Number(u.discountValue||0)*Number(u.qty||0)).toFixed(2):"—",alignment:"right"},{text:F(u).toFixed(2),alignment:"right"}])],C={pageSize:"A4",pageMargins:[28,28,28,28],content:[{columns:[[{text:t?.name||"",bold:!0},{text:t?.addresses?.length?`${t.addresses[0].line1}, ${t.addresses[0].city}`:""},t?.taxId?{text:`VAT/TAX ID: ${t.taxId}`,color:"#6c757d",fontSize:9}:{}],[{text:"Credit Note",style:"title",alignment:"right"},{text:`No: ${o.number||""}`,bold:!0,alignment:"right"},{text:`Date: ${o.date||""}`,alignment:"right"},S.value?{text:`Ref Invoice: ${S.value.number}`,alignment:"right"}:{}]]},{text:" ",margin:[0,6]},{text:"Bill To",bold:!0},{text:s?.name||""},{text:s?.addresses?.length?`${s.addresses[0].line1}, ${s.addresses[0].city}`:""},o.reason?{text:`Reason: ${o.reason}`,margin:[0,6,0,0]}:{},{table:{headerRows:1,widths:["*",40,50,55,60],body:c},layout:"lightHorizontalLines",margin:[0,6,0,0]},{columns:[{text:" "},{width:180,alignment:"right",stack:[{text:`Subtotal: ${f.value.sub.toFixed(2)}`},{text:`Tax: ${f.value.tax.toFixed(2)}`},{text:`Total Credit: ${f.value.total.toFixed(2)}`,bold:!0}]}],margin:[0,8,0,0]}],footer:(u,N)=>({margin:[28,8,28,16],fontSize:9,text:r.settings?.creditNote?.footerText||""}),styles:{title:{fontSize:18,color:"#4a148c",bold:!0}},defaultStyle:{fontSize:10}};window.pdfMake.createPdf(C).download(`credit_note_${o.number||"edit"}.pdf`)}function tt(){o.id||(o.id=L("cn_")),!o.number&&r.settings?.creditNote?.autoNumberOnSave&&E();const n=JSON.parse(JSON.stringify(o));lt(r.creditNotes,n,"id"),Q.push(`/credit-notes/${o.id}`)}return(n,t)=>(i(),l("div",at,[e("div",rt,[$(X,{title:G.value?"Edit Credit Note":"Create Credit Note"},{default:J(()=>[e("div",ut,[t[31]||(t[31]=e("div",{class:"col-12"},[e("div",{class:"subsection-title"},"Credit Note Info")],-1)),e("div",ct,[t[13]||(t[13]=e("label",{class:"form-label"},"Credit Note Number",-1)),e("div",mt,[p(e("input",{class:"form-control","onUpdate:modelValue":t[0]||(t[0]=s=>o.number=s),placeholder:"e.g., CN-0001"},null,512),[[U,o.number]]),e("button",{class:"btn btn-outline-secondary",type:"button",onClick:E},"Auto")])]),e("div",pt,[t[14]||(t[14]=e("label",{class:"form-label"},"Date",-1)),p(e("input",{class:"form-control",type:"date","onUpdate:modelValue":t[1]||(t[1]=s=>o.date=s)},null,512),[[U,o.date]])]),e("div",vt,[t[16]||(t[16]=e("label",{class:"form-label"},"Status",-1)),p(e("select",{class:"form-select","onUpdate:modelValue":t[2]||(t[2]=s=>o.status=s)},[...t[15]||(t[15]=[e("option",{value:"draft"},"Draft",-1),e("option",{value:"issued"},"Issued",-1),e("option",{value:"applied"},"Applied",-1),e("option",{value:"voided"},"Voided",-1)])],512),[[x,o.status]])]),t[32]||(t[32]=e("div",{class:"col-12"},[e("div",{class:"subsection-title mt-1"},"Reference Invoice")],-1)),e("div",ft,[t[18]||(t[18]=e("label",{class:"form-label"},"Original Invoice",-1)),p(e("select",{class:"form-select","onUpdate:modelValue":t[3]||(t[3]=s=>o.originalInvoiceId=s)},[t[17]||(t[17]=e("option",{value:""},"—",-1)),(i(!0),l(I,null,g(W.value,s=>(i(),l("option",{key:s.id,value:s.id},d(s.number)+" — "+d(s.date)+" — "+d(h(r).customers.find(c=>c.id===s.customerId)?.name),9,bt))),128))],512),[[x,o.originalInvoiceId]]),t[19]||(t[19]=e("div",{class:"form-text"},"Selecting an invoice will auto-fill parties and items (adjust as needed).",-1))]),t[33]||(t[33]=e("div",{class:"col-12"},[e("div",{class:"subsection-title mt-1"},"Parties")],-1)),e("div",xt,[t[23]||(t[23]=e("label",{class:"form-label"},"Merchant",-1)),p(e("select",{class:"form-select","onUpdate:modelValue":t[4]||(t[4]=s=>o.merchantId=s),disabled:!!o.originalInvoiceId},[t[20]||(t[20]=e("option",{value:""},"Select merchant",-1)),(i(!0),l(I,null,g(h(r).merchants,s=>(i(),l("option",{key:s.id,value:s.id},d(s.name),9,It))),128))],8,yt),[[x,o.merchantId]]),v.value?(i(),l("div",gt,[e("div",ht,[t[21]||(t[21]=e("label",{class:"form-label small mb-1"},"Address",-1)),p(e("select",{class:"form-select form-select-sm","onUpdate:modelValue":t[5]||(t[5]=s=>o.merchantAddressId=s)},[(i(!0),l(I,null,g(M.value,s=>(i(),l("option",{key:s.id,value:s.id},d(s.type)+" — "+d(s.city),9,_t))),128))],512),[[x,o.merchantAddressId]])]),e("div",wt,[t[22]||(t[22]=e("label",{class:"form-label small mb-1"},"Contact",-1)),p(e("select",{class:"form-select form-select-sm","onUpdate:modelValue":t[6]||(t[6]=s=>o.merchantContactId=s)},[(i(!0),l(I,null,g(j.value,s=>(i(),l("option",{key:s.id,value:s.id},d(s.type)+" — "+d(s.name),9,Ct))),128))],512),[[x,o.merchantContactId]])])])):a("",!0)]),e("div",Nt,[t[27]||(t[27]=e("label",{class:"form-label"},"Customer",-1)),p(e("select",{class:"form-select","onUpdate:modelValue":t[7]||(t[7]=s=>o.customerId=s),disabled:!!o.originalInvoiceId},[t[24]||(t[24]=e("option",{value:""},"Select customer",-1)),(i(!0),l(I,null,g(h(r).customers,s=>(i(),l("option",{key:s.id,value:s.id},d(s.name),9,St))),128))],8,kt),[[x,o.customerId]]),y.value?(i(),l("div",At,[e("div",Tt,[t[25]||(t[25]=e("label",{class:"form-label small mb-1"},"Address",-1)),p(e("select",{class:"form-select form-select-sm","onUpdate:modelValue":t[8]||(t[8]=s=>o.customerAddressId=s)},[(i(!0),l(I,null,g(q.value,s=>(i(),l("option",{key:s.id,value:s.id},d(s.type)+" — "+d(s.city),9,Vt))),128))],512),[[x,o.customerAddressId]])]),e("div",Dt,[t[26]||(t[26]=e("label",{class:"form-label small mb-1"},"Contact",-1)),p(e("select",{class:"form-select form-select-sm","onUpdate:modelValue":t[9]||(t[9]=s=>o.customerContactId=s)},[(i(!0),l(I,null,g(R.value,s=>(i(),l("option",{key:s.id,value:s.id},d(s.type)+" — "+d(s.name),9,Ft))),128))],512),[[x,o.customerContactId]])])])):a("",!0)]),e("div",Pt,[t[29]||(t[29]=e("label",{class:"form-label"},"Reason",-1)),p(e("select",{class:"form-select","onUpdate:modelValue":t[10]||(t[10]=s=>o.reason=s)},[...t[28]||(t[28]=[e("option",{value:""},"—",-1),e("option",null,"Goods returned (within 7 days)",-1),e("option",null,"Damaged goods (Sundarban transit)",-1),e("option",null,"Pricing adjustment",-1),e("option",null,"Promotional discount",-1),e("option",null,"Service cancellation",-1),e("option",null,"Advance refund",-1)])],512),[[x,o.reason]])]),t[34]||(t[34]=e("div",{class:"col-12"},[e("div",{class:"subsection-title mt-2"},"Items & Notes")],-1)),e("div",$t,[$(it,{items:o.items,products:h(r).products,taxes:h(r).taxes,onUpdate:t[11]||(t[11]=s=>o.items=s)},null,8,["items","products","taxes"])]),e("div",Ut,[t[30]||(t[30]=e("label",{class:"form-label"},"Notes",-1)),p(e("textarea",{class:"form-control",rows:"2","onUpdate:modelValue":t[12]||(t[12]=s=>o.notes=s),placeholder:"Optional notes to show on credit note"},null,512),[[U,o.notes]])])]),e("div",Mt,[e("div",jt,[e("div",qt,[e("span",Rt,"Subtotal: "+d(f.value.sub.toFixed(2)),1),e("span",zt,"Tax: "+d(f.value.tax.toFixed(2)),1),e("span",Ot,"Total Credit: "+d(f.value.total.toFixed(2)),1)]),e("div",{class:"d-flex gap-2"},[e("button",{class:"btn btn-outline-secondary",type:"button",onClick:Y},"Print"),e("button",{class:"btn btn-primary",type:"button",onClick:Z},"Download PDF"),e("button",{class:"btn btn-success",type:"button",onClick:tt},"Save")])])])]),_:1},8,["title"])]),e("div",Bt,[$(X,{title:"Preview"},{default:J(()=>[e("div",{class:"print-area",ref_key:"printRef",ref:T},[e("div",Et,[e("div",Lt,[e("strong",null,d(v.value?.name||"Select Merchant"),1),t[35]||(t[35]=e("br",null,null,-1)),V.value?(i(),l("span",Jt,d(V.value.line1)+", "+d(V.value.city),1)):a("",!0),V.value?(i(),l("br",Xt)):a("",!0),v.value?.taxId?(i(),l("span",Ht,"VAT/TAX ID: "+d(v.value.taxId),1)):a("",!0),v.value?.taxId?(i(),l("br",Qt)):a("",!0),_.value?(i(),l("span",Gt,[A(d(_.value.name),1),_.value.email?(i(),l("span",Wt," · "+d(_.value.email),1)):a("",!0),_.value.phone?(i(),l("span",Kt," · "+d(_.value.phone),1)):a("",!0)])):a("",!0)]),e("div",Yt,[t[39]||(t[39]=e("h4",{class:"mb-1"},"Credit Note",-1)),e("div",null,[t[36]||(t[36]=e("span",{class:"text-muted"},"No:",-1)),A(" "+d(o.number||"(not set)"),1)]),e("div",null,[t[37]||(t[37]=e("span",{class:"text-muted"},"Date:",-1)),A(" "+d(o.date),1)]),S.value?(i(),l("div",Zt,[t[38]||(t[38]=e("span",{class:"text-muted"},"Ref Invoice:",-1)),A(" "+d(S.value?.number),1)])):a("",!0)])]),e("div",te,[t[40]||(t[40]=e("div",{class:"text-uppercase muted-label"},"Bill To",-1)),e("div",ee,d(y.value?.name||"Select Customer"),1),D.value?(i(),l("div",se,d(D.value.line1)+", "+d(D.value.city),1)):a("",!0),y.value?.taxId?(i(),l("div",oe,"VAT/TAX ID: "+d(y.value.taxId),1)):a("",!0),o.reason?(i(),l("div",ne,"Reason: "+d(o.reason),1)):a("",!0),w.value?(i(),l("div",de,[A(d(w.value.name),1),w.value.email?(i(),l("span",le," · "+d(w.value.email),1)):a("",!0),w.value.phone?(i(),l("span",ie," · "+d(w.value.phone),1)):a("",!0)])):a("",!0)]),e("table",ae,[t[42]||(t[42]=e("thead",{class:"table-light"},[e("tr",null,[e("th",null,"Product / Description"),e("th",{class:"text-end"},"Qty"),e("th",{class:"text-end"},"Unit"),e("th",{class:"text-end"},"Discount"),e("th",{class:"text-end"},"Line")])],-1)),e("tbody",null,[(i(!0),l(I,null,g(o.items,s=>(i(),l("tr",{key:s.id},[e("td",null,[e("div",re,d(h(r).products.find(c=>c.id===s.productId)?.name||s.description||"—"),1),s.description&&h(r).products.find(c=>c.id===s.productId)?.name!==s.description?(i(),l("div",ue,d(s.description),1)):a("",!0)]),e("td",ce,d(s.qty),1),e("td",me,d(Number(s.unitPrice||0).toFixed(2)),1),e("td",pe,[(s.discountType||"none")==="percent"?(i(),l("span",ve,"-"+d(Number(s.discountValue||0).toFixed(0))+"%",1)):(s.discountType||"none")==="fixed"?(i(),l("span",fe,"-"+d((Number(s.discountValue||0)*Number(s.qty||0)).toFixed(2)),1)):(i(),l("span",be,"—"))]),e("td",xe,d(F(s).toFixed(2)),1)]))),128)),o.items.length===0?(i(),l("tr",ye,[...t[41]||(t[41]=[e("td",{colspan:"5",class:"text-muted"},"No items",-1)])])):a("",!0)])]),e("div",Ie,[t[46]||(t[46]=e("div",{class:"flex-grow-1"},null,-1)),e("div",ge,[e("div",he,[t[43]||(t[43]=e("span",null,"Subtotal",-1)),e("span",null,d(f.value.sub.toFixed(2)),1)]),e("div",_e,[t[44]||(t[44]=e("span",null,"Tax",-1)),e("span",null,d(f.value.tax.toFixed(2)),1)]),e("div",we,[t[45]||(t[45]=e("span",null,"Total Credit",-1)),e("span",null,d(f.value.total.toFixed(2)),1)])])]),o.notes?(i(),l("div",Ce,[t[47]||(t[47]=e("strong",null,"Notes",-1)),e("div",Ne,d(o.notes),1)])):a("",!0)],512)]),_:1})])]))}};export{Ve as default};
